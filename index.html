<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="main.css">

    <script src="./node_modules/web3/dist/web3.min.js"></script>

</head>
<body>
		<div class="container">

				<h1>King of the hill</h1>
				<span id="countKings"></span>
				<span id="endTime"></span>
		
				<h2 id="king"></h2>
				<span id="kingTrans"></span>
				<hr>
		
				<img id="loader" src="https://media2.giphy.com/media/131tNuGktpXGhy/giphy.gif?cid=790b76115cfef426664371312e9b35be&rid=giphy.gif">
		
				<label for="fName" class="col-lg-2 control-label">First Name</label>
				<input id="fName" type="text">
		
				<label for="start" class="col-lg-2 control-label">Start</label>
				<input id="start" type="text">
		
				<button id="button">Update King</button>
		
		</div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
        // var Web3 = require("web3")
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        web3.eth.defaultAccount = web3.eth.accounts[0];

        var KingContract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [],
		"name": "kingWin",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_address",
				"type": "address"
			},
			{
				"name": "_start",
				"type": "uint256"
			},
			{
				"name": "_fName",
				"type": "string"
			},
			{
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "setKing",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_timeLimit",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "fName",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "start",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "kingInfo",
		"type": "event"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "countKings",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "endTime",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_address",
				"type": "address"
			}
		],
		"name": "getKing",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getKings",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "kingAccts",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "price",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "total",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]);

var King = KingContract.at('0x82181d776c0d140d4996c851cc91f57fb6492ad1');

var kingEvent = King.kingInfo({},'latest');


function makeDeposit(){
   var etherAmount = web3.toBigNumber($("#start").val());
   var weiValue = web3.toWei(etherAmount,'ether');
   King.setKing(web3.eth.accounts[0], weiValue, $("#fName").val(), weiValue, function(err, res){ });
   }

kingEvent.watch(function (err, result) {
    if (!err) {
		//web3.eth.sendTransaction({from:web3.eth.defaultAccount ,to:0x30862d97d39cef64faec5d37e919ad92ecdab02d , value:web3.toWei(0.05, "ether")}); 
        if (result.blockHash != $("#kingtrans").html()) 
            $("#loader").hide();
            
        $("#kingTrans").html('Block hash: ' +result.blockHash);
        $("#king").html(web3.toAscii(result.args.fName) + ' :' + result.args.start + result.args.endTime);
    } else {
        $("#loader").hide();
    }
});

King.countKings((err, res) => {
    if (res)
        $("#countKings").html(res.c + ' Kings'); 
});

		
$("#button").click(function() {
	$("#loader").show();
	

	// king.setKing(web3.eth.defaultAccount, $("#start").val(), $("#fName").val(),{{from:web3.eth.accounts[0], value:web3.toWei(0.05, "ether")}},function (error, result){   if(!error){
    //                     console.log(result);
    //                 } else{
    //                     console.log(error);
    //                 }
	// 		});
		
 
  	makeDeposit();
   	// King.setKing(web3.eth.accounts[0], web3.toWei(0.1, "ether"), $("#fName").val(), web3.toWei(0.1, "ether"), function(err, res){ })
    //  King.setKing(web3.eth.defaultAccount, $("#start").val(), $("#fName").val(), web3.toWei(0.1, "ether"), (err, res) => {

		//let send = web3.eth.sendTransaction({value:web3.toWei(0.05, "ether")});
// 		if (err) 
//             $("#loader").hide();
// })
 });
$("#endTime").html(endTime); 


</script>

</body>
</html>